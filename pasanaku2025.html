<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Pasanaku</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <style>
        :root {
            --primary-color: #1a2332;
            --secondary-color: #17a2b8;
            --turquoise-dark: #0a5e6b;
            --turquoise-light: #17a2b8;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --dark-bg: #000000;
            --light-bg: #f8f9fa;
            --paid-color: #28a745;
            --pending-color: #6c757d;
            --glass-bg: rgba(255, 255, 255, 0.95);
            --shadow-light: 0 5px 15px rgba(0, 0, 0, 0.1);
            --shadow-medium: 0 10px 30px rgba(0, 0, 0, 0.15);
            --shadow-heavy: 0 20px 40px rgba(0, 0, 0, 0.3);
            --border-radius: 15px;
            --transition-fast: 0.2s ease;
            --transition-medium: 0.3s ease;
        }

        * {
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(135deg, var(--dark-bg) 0%, var(--primary-color) 50%, var(--turquoise-dark) 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 0;
        }

        .main-container {
            background: var(--glass-bg);
            border-radius: 20px;
            box-shadow: var(--shadow-heavy);
            backdrop-filter: blur(10px);
            margin: 20px auto;
            overflow: hidden;
            border: 2px solid var(--turquoise-light);
            max-width: 1200px;
        }

        .header {
            background: linear-gradient(135deg, var(--primary-color), var(--turquoise-dark));
            color: white;
            padding: 2rem;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(23,162,184,0.2) 0%, transparent 70%);
            animation: rotate 20s linear infinite;
            will-change: transform;
        }

        @keyframes rotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .header h1 {
            font-size: clamp(1.5rem, 4vw, 2.5rem);
            font-weight: bold;
            margin-bottom: 0.5rem;
            position: relative;
            z-index: 2;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header .subtitle {
            font-size: clamp(0.9rem, 2.5vw, 1.2rem);
            opacity: 0.9;
            position: relative;
            z-index: 2;
        }

        .info-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.25rem;
            padding: 2rem;
            background: linear-gradient(135deg, rgba(23,162,184,0.1), rgba(26,35,50,0.1));
        }

        .info-card {
            background: linear-gradient(135deg, white, #f8f9fa);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            text-align: center;
            box-shadow: var(--shadow-light);
            transition: all var(--transition-medium);
            border: 2px solid transparent;
            cursor: default;
        }

        .info-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(23,162,184,0.3);
            border-color: var(--turquoise-light);
        }

        .info-card i {
            font-size: 2.5rem;
            margin-bottom: 1rem;
            color: var(--turquoise-dark);
        }

        .info-card h3 {
            color: var(--primary-color);
            margin-bottom: 0.5rem;
            font-size: 1.1rem;
        }

        .info-card .value {
            font-size: clamp(1.3rem, 3vw, 2rem);
            font-weight: bold;
            color: var(--turquoise-dark);
        }

        .participants-section {
            padding: 2rem;
            background: linear-gradient(135deg, rgba(0,0,0,0.05), rgba(23,162,184,0.05));
        }

        .section-title {
            text-align: center;
            color: var(--primary-color);
            margin-bottom: 2rem;
            font-size: clamp(1.3rem, 3vw, 2rem);
            font-weight: bold;
        }

        .participant-card {
            background: linear-gradient(135deg, white, #f8f9fa);
            border-radius: 12px;
            padding: 1.25rem;
            margin-bottom: 1rem;
            box-shadow: var(--shadow-light);
            transition: all var(--transition-medium);
            border-left: 5px solid var(--turquoise-light);
            position: relative;
            overflow: hidden;
        }

        .participant-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: var(--turquoise-light);
            transition: width var(--transition-medium);
        }

        .participant-card:hover {
            transform: translateX(5px);
            box-shadow: 0 8px 25px rgba(23,162,184,0.2);
        }

        .participant-card:hover::before {
            width: 100%;
            opacity: 0.1;
        }

        .participant-card.completed {
            border-left-color: var(--paid-color);
            background: linear-gradient(135deg, rgba(40, 167, 69, 0.1), rgba(40, 167, 69, 0.05));
        }

        .participant-card.completed::before {
            background: var(--paid-color);
        }

        .participant-card.current {
            border-left-color: var(--warning-color);
            background: linear-gradient(135deg, rgba(255, 193, 7, 0.1), rgba(255, 193, 7, 0.05));
            animation: pulse 2s infinite;
        }

        .participant-card.current::before {
            background: var(--warning-color);
        }

        .participant-card.pending {
            border-left-color: var(--pending-color);
        }

        .participant-card.pending::before {
            background: var(--pending-color);
        }

        .participant-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .participant-name {
            font-size: 1.1rem;
            font-weight: bold;
            color: var(--primary-color);
        }

        .participant-date {
            font-size: 0.95rem;
            color: var(--turquoise-dark);
            margin-top: 0.25rem;
        }

        .payment-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .status-badge {
            padding: 0.4rem 0.8rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
            text-transform: uppercase;
            white-space: nowrap;
        }

        .status-completed {
            background: var(--paid-color);
            color: white;
        }

        .status-current {
            background: var(--warning-color);
            color: white;
            animation: blink 1.5s infinite;
        }

        .status-pending {
            background: var(--pending-color);
            color: white;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.7; }
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 193, 7, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(255, 193, 7, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 193, 7, 0); }
        }

        .progress-section {
            padding: 2rem;
            background: linear-gradient(135deg, white, rgba(23,162,184,0.05));
        }

        .progress-container {
            position: relative;
            height: 30px;
            background: rgba(0,0,0,0.1);
            border-radius: 15px;
            overflow: hidden;
            margin: 1.5rem 0;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--turquoise-dark), var(--turquoise-light));
            border-radius: 15px;
            transition: width 1s ease-in-out;
            position: relative;
            overflow: hidden;
        }

        .progress-bar::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: shine 2s infinite;
        }

        @keyframes shine {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        .progress-text {
            text-align: center;
            font-weight: bold;
            color: var(--primary-color);
            margin-top: 0.75rem;
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin: 1.5rem 0;
        }

        .controls {
            text-align: center;
            padding: 1.5rem;
            background: linear-gradient(135deg, rgba(0,0,0,0.05), rgba(23,162,184,0.05));
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 1rem;
        }

        .btn-custom {
            background: linear-gradient(135deg, var(--turquoise-dark), var(--turquoise-light));
            border: none;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 25px;
            font-weight: bold;
            transition: all var(--transition-medium);
            box-shadow: 0 4px 15px rgba(23,162,184,0.3);
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
        }

        .btn-custom:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(23,162,184,0.4);
            color: white;
            background: linear-gradient(135deg, var(--turquoise-light), var(--turquoise-dark));
        }

        .btn-owner {
            background: linear-gradient(135deg, var(--primary-color), var(--dark-bg));
        }

        .btn-owner:hover {
            background: linear-gradient(135deg, var(--dark-bg), var(--primary-color));
        }

        .summary-card {
            background: linear-gradient(135deg, var(--primary-color), var(--turquoise-dark));
            color: white;
            border-radius: var(--border-radius);
            padding: 2rem;
            margin: 1.5rem 2rem;
            text-align: center;
            box-shadow: var(--shadow-medium);
        }

        .summary-card h4 {
            margin-bottom: 1.5rem;
            font-size: clamp(1.2rem, 3vw, 1.5rem);
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .summary-item {
            background: rgba(255, 255, 255, 0.2);
            padding: 1rem;
            border-radius: 10px;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .summary-item .label {
            font-size: 0.85rem;
            opacity: 0.8;
            margin-bottom: 0.5rem;
        }

        .summary-item .value {
            font-size: clamp(1rem, 2.5vw, 1.3rem);
            font-weight: bold;
        }

        .modal-content {
            background: linear-gradient(135deg, white, #f8f9fa);
            border: 2px solid var(--turquoise-light);
            border-radius: var(--border-radius);
        }

        .modal-header {
            background: linear-gradient(135deg, var(--turquoise-dark), var(--turquoise-light));
            color: white;
            border-radius: 13px 13px 0 0;
        }

        .form-control:focus {
            border-color: var(--turquoise-light);
            box-shadow: 0 0 0 0.2rem rgba(23,162,184,0.25);
        }

        .notification-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1060;
            max-width: 350px;
        }

        .notification {
            background: linear-gradient(135deg, var(--turquoise-dark), var(--turquoise-light));
            color: white;
            padding: 1rem 1.25rem;
            border-radius: 10px;
            margin-bottom: 0.75rem;
            box-shadow: var(--shadow-light);
            animation: slideIn 0.3s ease-out;
            cursor: pointer;
        }

        .notification.success {
            background: linear-gradient(135deg, var(--paid-color), #20c997);
        }

        .notification.warning {
            background: linear-gradient(135deg, var(--warning-color), #ffca2c);
            color: var(--dark-bg);
        }

        .notification.error {
            background: linear-gradient(135deg, var(--danger-color), #ff6b6b);
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .loading-spinner {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 9999;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(23,162,184,0.3);
            border-top: 4px solid var(--turquoise-light);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .main-container {
                margin: 10px;
                border-radius: 15px;
            }

            .header {
                padding: 1.5rem 1rem;
            }

            .info-cards {
                grid-template-columns: 1fr;
                padding: 1.5rem;
                gap: 1rem;
            }

            .participant-info {
                flex-direction: column;
                align-items: flex-start;
            }

            .participants-section, .progress-section {
                padding: 1.5rem;
            }

            .summary-card {
                margin: 1rem;
                padding: 1.5rem;
            }

            .controls {
                flex-direction: column;
                align-items: stretch;
            }

            .btn-custom {
                justify-content: center;
            }
        }

        @media (max-width: 480px) {
            .info-cards {
                padding: 1rem;
            }

            .participants-section, .progress-section {
                padding: 1rem;
            }
        }

        /* Accessibility improvements */
        .btn:focus, .form-control:focus {
            outline: 2px solid var(--turquoise-light);
            outline-offset: 2px;
        }

        .participant-card:focus-within {
            outline: 2px solid var(--turquoise-light);
            outline-offset: 2px;
        }

        /* Print styles */
        @media print {
            .controls, .notification-container {
                display: none !important;
            }
            
            .main-container {
                box-shadow: none;
                border: 1px solid #000;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Spinner -->
    <div class="loading-spinner" id="loadingSpinner">
        <div class="spinner"></div>
    </div>

    <!-- Notification Container -->
    <div class="notification-container" id="notificationContainer"></div>

    <div class="container-fluid">
        <div class="main-container">
            <!-- Header -->
            <header class="header">
                <h1><i class="fas fa-coins" aria-hidden="true"></i> Sistema de Pasanaku</h1>
                <p class="subtitle">Gestión inteligente de tu grupo de ahorro</p>
            </header>

            <!-- Cards de información -->
            <section class="info-cards">
                <div class="info-card">
                    <i class="fas fa-money-bill-wave" aria-hidden="true"></i>
                    <h3>Monto Total</h3>
                    <div class="value" id="totalAmount">2,000 Bs</div>
                </div>
                <div class="info-card">
                    <i class="fas fa-calendar-week" aria-hidden="true"></i>
                    <h3>Pago Semanal</h3>
                    <div class="value" id="weeklyAmount">200 Bs</div>
                </div>
                <div class="info-card">
                    <i class="fas fa-users" aria-hidden="true"></i>
                    <h3>Participantes</h3>
                    <div class="value" id="totalParticipants">10</div>
                </div>
                <div class="info-card">
                    <i class="fas fa-clock" aria-hidden="true"></i>
                    <h3>Duración</h3>
                    <div class="value" id="duration">10 semanas</div>
                </div>
            </section>

            <!-- Resumen del estado actual -->
            <div class="summary-card">
                <h4><i class="fas fa-chart-line" aria-hidden="true"></i> Estado Actual del Pasanaku</h4>
                <div class="summary-grid">
                    <div class="summary-item">
                        <div class="label">Semana Actual</div>
                        <div class="value" id="currentWeek">1</div>
                    </div>
                    <div class="summary-item">
                        <div class="label">Recaudado</div>
                        <div class="value" id="totalCollected">0 Bs</div>
                    </div>
                    <div class="summary-item">
                        <div class="label">Por Recaudar</div>
                        <div class="value" id="totalPending">2,000 Bs</div>
                    </div>
                    <div class="summary-item">
                        <div class="label">Próximo Pago</div>
                        <div class="value" id="nextPayment">Dayana Zunq</div>
                    </div>
                </div>
            </div>

            <!-- Progreso General -->
            <section class="progress-section">
                <h2 class="section-title"><i class="fas fa-chart-pie" aria-hidden="true"></i> Progreso General</h2>
                <div class="progress-container" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                    <div class="progress-bar" id="mainProgress" style="width: 0%"></div>
                </div>
                <div class="progress-text" id="progressText">0% completado (0 de 10 semanas)</div>
                
                <!-- Canvas para gráfico -->
                <div class="chart-container">
                    <canvas id="progressChart" role="img" aria-label="Gráfico de progreso del pasanaku"></canvas>
                </div>
            </section>

            <!-- Lista de Participantes -->
            <section class="participants-section">
                <h2 class="section-title"><i class="fas fa-list" aria-hidden="true"></i> Cronograma de Participantes</h2>
                <div id="participantsList" role="list"></div>
            </section>

            <!-- Controles -->
            <nav class="controls" role="navigation">
                <button class="btn btn-custom btn-owner" onclick="showOwnerControls()" aria-label="Abrir controles de dueño">
                    <i class="fas fa-user-shield" aria-hidden="true"></i> Controles de Dueño
                </button>
                <button class="btn btn-custom" onclick="exportData()" aria-label="Exportar datos del pasanaku">
                    <i class="fas fa-download" aria-hidden="true"></i> Exportar Datos
                </button>
                <button class="btn btn-custom" onclick="showCollectionNotification()" aria-label="Notificar recolección">
                    <i class="fas fa-bell" aria-hidden="true"></i> Notificar Recolección
                </button>
            </nav>
        </div>
    </div>

    <!-- Modal para controles de dueño -->
    <div class="modal fade" id="ownerModal" tabindex="-1" aria-labelledby="ownerModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="ownerModalLabel"><i class="fas fa-user-shield" aria-hidden="true"></i> Controles de Dueño</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="ownerPassword" class="form-label">Contraseña de Dueño:</label>
                        <input type="password" class="form-control" id="ownerPassword" placeholder="Ingrese la contraseña">
                    </div>
                    <div id="ownerControls" style="display: none;">
                        <h6 class="mb-3">Marcar Pagos Recibidos:</h6>
                        <div id="paymentControls"></div>
                        <hr>
                        <button class="btn btn-warning me-2" onclick="resetPasanaku()" aria-label="Reiniciar pasanaku">
                            <i class="fas fa-refresh" aria-hidden="true"></i> Reiniciar Pasanaku
                        </button>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    <button type="button" class="btn btn-custom" onclick="validateOwnerPassword()">Acceder</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    
    <script>
        // Cargar jsPDF
        const { jsPDF } = window.jspdf;
        
        class PasanakuSystem {
            constructor() {
                this.config = {
                    weeklyAmount: 200,
                    totalAmount: 2000,
                    ownerPassword: "wandi2025"
                };

                this.randomNames = [
                    "Carlos Mendoza", "Ana Torres", "Luis Fernández", "María Rojas", 
                    "Pedro Vargas", "Sofía Castro", "Juan Pérez", "Laura Gómez",
                    "Diego Suárez", "Valeria Ruiz", "Miguel Soto", "Camila Herrera"
                ];
                
                this.participants = [
                    { id: 1, name: "Dayana Zuna", date: "13/08/25", paid: false },
                    { id: 2, name: "Jhonny López", date: "20/08/25", paid: false },
                    { id: 3, name: "Ariana Zuna", date: "27/08/25", paid: false },
                    { id: 4, name: "Bárbara Zeballos", date: "03/09/25", paid: false },
                    { id: 5, name: "Armando López ", date: "10/09/25", paid: false },
                    { id: 6, name: "Rolando Gutierrez"/*this.getRandomName()*/, date: "17/09/25", paid: false },
                    { id: 7, name: "Rosmery Segura", date: "24/09/25", paid: false },
                    { id: 8, name: "Jhose segura", date: "01/10/25", paid: false },
                    { id: 9, name: /*this.getRandomName()*/ "Diego", date: "08/10/25", paid: false },
                    { id: 10, name: "Moises Arrazola", date: "15/10/25", paid: false }
                ];

                this.state = {
                    currentWeek: 0,
                    weeklyPayments: {},
                    chart: null,
                    updateInterval: null
                };

                this.cache = {
                    elements: {},
                    lastUpdate: 0
                };

                this.init();
            }

            async init() {
                try {
                    this.showLoading(true);
                    
                    await this.loadData();
                    this.cacheElements();
                    this.initializeWeeklyPayments();
                    this.updateCurrentWeek();
                    
                    await this.render();
                    this.startTimer();
                    
                    this.showLoading(false);
                    this.showNotification('Sistema iniciado correctamente', 'success');
                } catch (error) {
                    console.error('Error al inicializar:', error);
                    this.showNotification('Error al inicializar el sistema', 'error');
                    this.showLoading(false);
                }
            }

            cacheElements() {
                const selectors = {
                    participantsList: '#participantsList',
                    mainProgress: '#mainProgress',
                    progressText: '#progressText',
                    currentWeek: '#currentWeek',
                    totalCollected: '#totalCollected',
                    totalPending: '#totalPending',
                    nextPayment: '#nextPayment',
                    totalParticipants: '#totalParticipants',
                    progressChart: '#progressChart',
                    paymentControls: '#paymentControls',
                    ownerControls: '#ownerControls',
                    loadingSpinner: '#loadingSpinner'
                };

                Object.entries(selectors).forEach(([key, selector]) => {
                    this.cache.elements[key] = document.querySelector(selector);
                });
            }

            showLoading(show) {
                const spinner = this.cache.elements.loadingSpinner;
                if (spinner) {
                    spinner.style.display = show ? 'block' : 'none';
                }
            }

            getRandomName() {
                return this.randomNames[Math.floor(Math.random() * this.randomNames.length)];
            }

            initializeWeeklyPayments() {
                for (let week = 0; week < this.participants.length; week++) {
                    if (!this.state.weeklyPayments[week]) {
                        this.state.weeklyPayments[week] = {};
                        this.participants.forEach(participant => {
                            this.state.weeklyPayments[week][participant.id] = false;
                        });
                    }
                }
            }

            updateCurrentWeek() {
                const startDate = new Date('2025-08-13');
                const currentDate = new Date();
                const diffTime = currentDate - startDate;
                const diffWeeks = Math.floor(diffTime / (1000 * 60 * 60 * 24 * 7));
                
                if (diffWeeks >= 0 && diffWeeks < this.participants.length) {
                    this.state.currentWeek = diffWeeks;
                } else if (diffWeeks >= this.participants.length) {
                    this.state.currentWeek = this.participants.length - 1;
                }
            }

            async render() {
                await Promise.all([
                    this.renderParticipants(),
                    this.updateProgress(),
                    this.updateSummary(),
                    this.createChart()
                ]);
            }

            renderParticipants() {
                const container = this.cache.elements.participantsList;
                if (!container) return;

                const fragment = document.createDocumentFragment();

                this.participants.forEach((participant, index) => {
                    const card = this.createParticipantCard(participant, index);
                    fragment.appendChild(card);
                });

                container.innerHTML = '';
                container.appendChild(fragment);
            }

            createParticipantCard(participant, index) {
                const card = document.createElement('div');
                card.className = 'participant-card';
                card.setAttribute('role', 'listitem');
                
                const weeklyPaid = this.getWeeklyPaymentCount(index);
                const totalExpected = this.participants.length;
                
                const { statusClass, statusText, statusIcon, cardClass } = this.getParticipantStatus(weeklyPaid, totalExpected, index);
                
                card.classList.add(cardClass);
                participant.paid = cardClass === 'completed';

                const isCurrentWeek = index === this.state.currentWeek;
                
                card.innerHTML = `
                    <div class="participant-info">
                        <div>
                            <div class="participant-name">
                                <i class="${statusIcon}" aria-hidden="true"></i> ${this.escapeHtml(participant.name)}
                            </div>
                            <div class="participant-date">
                                <i class="fas fa-calendar" aria-hidden="true"></i> ${participant.date}
                            </div>
                            ${isCurrentWeek ? 
                                `<div class="mt-2">
                                    <small class="text-info">
                                        <i class="fas fa-hand-holding-usd" aria-hidden="true"></i> 
                                        Le toca recoger ${this.config.totalAmount.toLocaleString()} Bs
                                    </small>
                                </div>` : ''}
                        </div>
                        <div class="payment-status">
                            <div class="status-badge status-${statusClass}" role="status" aria-label="${statusText}">
                                ${statusText}
                            </div>
                        </div>
                    </div>
                `;

                return card;
            }

            getParticipantStatus(weeklyPaid, totalExpected, index) {
                let statusClass = 'pending';
                let statusText = 'Pendiente';
                let statusIcon = 'fas fa-clock';
                let cardClass = 'pending';

                if (weeklyPaid === totalExpected && index < this.state.currentWeek) {
                    statusClass = 'completed';
                    statusText = 'Completo';
                    statusIcon = 'fas fa-check-circle';
                    cardClass = 'completed';
                } else if (index === this.state.currentWeek) {
                    statusClass = 'current';
                    statusText = `Actual (${weeklyPaid}/${totalExpected})`;
                    statusIcon = 'fas fa-arrow-right';
                    cardClass = 'current';
                } else if (index < this.state.currentWeek && weeklyPaid < totalExpected) {
                    statusClass = 'pending';
                    statusText = `Pendiente (${weeklyPaid}/${totalExpected})`;
                    cardClass = 'pending';
                }

                return { statusClass, statusText, statusIcon, cardClass };
            }

            getWeeklyPaymentCount(week) {
                if (!this.state.weeklyPayments[week]) return 0;
                
                return Object.values(this.state.weeklyPayments[week]).filter(paid => paid).length;
            }

            renderOwnerPaymentControls() {
                const container = this.cache.elements.paymentControls;
                if (!container) return;

                this.updateCurrentWeek();

                const currentWeekDiv = document.createElement('div');
                currentWeekDiv.className = 'mb-4 p-3 bg-light rounded';
                
                const weekTitle = document.createElement('h6');
                const currentParticipant = this.participants[this.state.currentWeek];
                weekTitle.innerHTML = `<i class="fas fa-calendar-week" aria-hidden="true"></i> Semana ${this.state.currentWeek + 1} - ${this.escapeHtml(currentParticipant?.name || 'Sin asignar')}`;
                currentWeekDiv.appendChild(weekTitle);

                this.participants.forEach(participant => {
                    const paymentDiv = this.createPaymentControl(participant);
                    currentWeekDiv.appendChild(paymentDiv);
                });

                const progressDiv = this.createWeekProgressDiv();
                currentWeekDiv.appendChild(progressDiv);
                
                container.innerHTML = '';
                container.appendChild(currentWeekDiv);
            }

            createPaymentControl(participant) {
                const paymentDiv = document.createElement('div');
                paymentDiv.className = 'd-flex align-items-center mb-2 p-2 bg-white rounded border';
                
                const isPaid = this.state.weeklyPayments[this.state.currentWeek]?.[participant.id] || false;
                const checkboxId = `payment_${this.state.currentWeek}_${participant.id}`;
                
                paymentDiv.innerHTML = `
                    <input type="checkbox" class="payment-checkbox me-2" 
                           id="${checkboxId}"
                           ${isPaid ? 'checked' : ''}
                           onchange="pasanakuSystem.togglePayment(${this.state.currentWeek}, ${participant.id})"
                           aria-label="Marcar pago de ${this.escapeHtml(participant.name)}">
                    <label for="${checkboxId}" class="flex-grow-1">
                        <strong>${this.escapeHtml(participant.name)}</strong> - ${this.config.weeklyAmount} Bs
                        ${isPaid ? '<span class="badge bg-success ms-2">Pagado</span>' : '<span class="badge bg-secondary ms-2">Pendiente</span>'}
                    </label>
                `;
                
                return paymentDiv;
            }

            createWeekProgressDiv() {
                const weeklyPaid = this.getWeeklyPaymentCount(this.state.currentWeek);
                const totalExpected = this.participants.length;
                const progressPercentage = (weeklyPaid / totalExpected) * 100;
                
                const progressDiv = document.createElement('div');
                progressDiv.className = 'mt-3';
                progressDiv.innerHTML = `
                    <div class="progress" role="progressbar" aria-valuenow="${progressPercentage}" aria-valuemin="0" aria-valuemax="100">
                        <div class="progress-bar bg-info" style="width: ${progressPercentage}%"></div>
                    </div>
                    <small class="text-muted">Progreso: ${weeklyPaid}/${totalExpected} participantes han pagado</small>
                `;
                
                return progressDiv;
            }

            togglePayment(week, participantId) {
                if (!this.state.weeklyPayments[week]) {
                    this.state.weeklyPayments[week] = {};
                }
                
                this.state.weeklyPayments[week][participantId] = !this.state.weeklyPayments[week][participantId];
                this.saveData();
                
                const weeklyPaid = this.getWeeklyPaymentCount(week);
                const totalExpected = this.participants.length;
                
                if (weeklyPaid === totalExpected && week === this.state.currentWeek) {
                    this.showNotification(`¡Todos los pagos de la semana ${week + 1} completados!`, 'success');
                    
                    // Avanzar automáticamente a la siguiente semana si es la semana actual
                    if (week === this.state.currentWeek && this.state.currentWeek < this.participants.length - 1) {
                        this.state.currentWeek++;
                        this.saveData();
                        this.showNotification(`Avanzando a la semana ${this.state.currentWeek + 1}`, 'info');
                    }
                }
                
                // Actualizar UI de forma optimizada
                this.debounceUpdate();
            }

            debounceUpdate() {
                if (this.updateTimeout) {
                    clearTimeout(this.updateTimeout);
                }
                
                this.updateTimeout = setTimeout(() => {
                    this.renderParticipants();
                    this.updateProgress();
                    this.updateSummary();
                    
                    if (this.cache.elements.ownerControls.style.display === 'block') {
                        this.renderOwnerPaymentControls();
                    }
                }, 100);
            }

            updateProgress() {
                const totalWeeks = this.participants.length;
                const completedWeeks = this.participants.filter((p, index) => {
                    return index < this.state.currentWeek && this.getWeeklyPaymentCount(index) === this.participants.length;
                }).length;

                const progress = Math.round((completedWeeks / totalWeeks) * 100);
                
                const progressBar = this.cache.elements.mainProgress;
                const progressText = this.cache.elements.progressText;
                
                if (progressBar) {
                    progressBar.style.width = `${progress}%`;
                    progressBar.setAttribute('aria-valuenow', progress);
                }
                
                if (progressText) {
                    progressText.textContent = `${progress}% completado (${completedWeeks} de ${totalWeeks} semanas)`;
                }

                if (this.state.chart) {
                    this.updateChart();
                }
            }

            updateSummary() {
                const totalParticipants = this.participants.length;
                const completedPayments = this.participants.filter((p, index) => {
                    return index < this.state.currentWeek && this.getWeeklyPaymentCount(index) === totalParticipants;
                }).length;

                const totalCollected = completedPayments * this.config.weeklyAmount * totalParticipants;
                const totalPending = this.config.totalAmount - totalCollected;

                this.updateElement('totalCollected', `${totalCollected.toLocaleString()} Bs`);
                this.updateElement('totalPending', `${totalPending.toLocaleString()} Bs`);
                this.updateElement('currentWeek', this.state.currentWeek + 1);
                
                const nextPaymentName = this.state.currentWeek < this.participants.length 
                    ? this.participants[this.state.currentWeek].name 
                    : "Finalizado";
                
                this.updateElement('nextPayment', nextPaymentName);
            }

            updateElement(id, content) {
                const element = this.cache.elements[id] || document.getElementById(id);
                if (element) {
                    element.textContent = content;
                }
            }

            async createChart() {
                const canvas = this.cache.elements.progressChart;
                if (!canvas) return;

                const ctx = canvas.getContext('2d');
                
                const chartData = this.getChartData();
                
                if (this.state.chart) {
                    this.state.chart.destroy();
                }

                this.state.chart = new Chart(ctx, {
                    type: 'bar',
                    data: chartData,
                    options: this.getChartOptions()
                });
            }

            getChartData() {
                const labels = this.participants.map(p => p.date);
                const data = this.participants.map((p, index) => {
                    const paidCount = this.getWeeklyPaymentCount(index);
                    const totalExpected = this.participants.length;
                    return Math.round((paidCount / totalExpected) * 100);
                });

                return {
                    labels: labels,
                    datasets: [{
                        label: 'Porcentaje de pagos completados',
                        data: data,
                        backgroundColor: data.map((val, index) => this.getBarColor(val, index, 0.7)),
                        borderColor: data.map((val, index) => this.getBarColor(val, index, 1)),
                        borderWidth: 1
                    }]
                };
            }

            getBarColor(value, index, alpha) {
                if (index === this.state.currentWeek) return `rgba(255, 193, 7, ${alpha})`;
                if (value === 100) return `rgba(40, 167, 69, ${alpha})`;
                if (value > 0) return `rgba(23, 162, 184, ${alpha})`;
                return `rgba(108, 117, 125, ${alpha})`;
            }

            getChartOptions() {
                return {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            title: {
                                display: true,
                                text: 'Porcentaje completado'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Semanas'
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: (context) => `${context.parsed.y}% completado`
                            }
                        },
                        legend: {
                            display: false
                        }
                    },
                    animation: {
                        duration: 1000,
                        easing: 'easeInOutQuart'
                    }
                };
            }

            updateChart() {
                if (!this.state.chart) return;

                const data = this.participants.map((p, index) => {
                    const paidCount = this.getWeeklyPaymentCount(index);
                    const totalExpected = this.participants.length;
                    return Math.round((paidCount / totalExpected) * 100);
                });

                this.state.chart.data.datasets[0].data = data;
                this.state.chart.data.datasets[0].backgroundColor = data.map((val, index) => this.getBarColor(val, index, 0.7));
                this.state.chart.data.datasets[0].borderColor = data.map((val, index) => this.getBarColor(val, index, 1));
                this.state.chart.update('none');
            }

            startTimer() {
                // Limpiar timer existente
                if (this.state.updateInterval) {
                    clearInterval(this.state.updateInterval);
                }

                // Actualizar cada hora
                this.state.updateInterval = setInterval(() => {
                    this.updateCurrentWeek();
                    this.render();
                }, 3600000);

                // También actualizar cada 5 minutos para cambios menores
                setInterval(() => {
                    const now = Date.now();
                    if (now - this.cache.lastUpdate > 300000) { // 5 minutos
                        this.updateSummary();
                        this.cache.lastUpdate = now;
                    }
                }, 300000);
            }

            showOwnerControls() {
                const modal = new bootstrap.Modal(document.getElementById('ownerModal'));
                modal.show();
            }

            validateOwnerPassword() {
                const password = document.getElementById('ownerPassword').value;
                if (password === this.config.ownerPassword) {
                    this.cache.elements.ownerControls.style.display = 'block';
                    this.updateCurrentWeek();
                    this.renderOwnerPaymentControls();
                    this.showNotification('Acceso concedido como dueño', 'success');
                } else {
                    this.showNotification('Contraseña incorrecta', 'error');
                }
            }

            resetPasanaku() {
                if (confirm('¿Estás seguro de que deseas reiniciar todo el pasanaku? Esto borrará todos los datos de pagos.')) {
                    this.state.weeklyPayments = {};
                    this.initializeWeeklyPayments();
                    this.state.currentWeek = 0;
                    this.saveData();
                    this.render();
                    this.showNotification('Pasanaku reiniciado correctamente', 'success');
                }
            }

            exportData() {
                try {
                    // Crear un nuevo documento PDF
                    const doc = new jsPDF();
                    
                    // Configuración del documento
                    doc.setFont('helvetica');
                    doc.setFontSize(18);
                    doc.setTextColor(40, 53, 82);
                    
                    // Título del documento
                    doc.text('Reporte del Pasanaku', 105, 15, { align: 'center' });
                    
                    // Fecha de generación
                    doc.setFontSize(10);
                    doc.text(`Generado el: ${new Date().toLocaleDateString()}`, 105, 22, { align: 'center' });
                    
                    // Información general
                    doc.setFontSize(12);
                    doc.text(`Monto Total: ${this.config.totalAmount.toLocaleString()} Bs`, 14, 30);
                    doc.text(`Pago Semanal: ${this.config.weeklyAmount.toLocaleString()} Bs`, 14, 37);
                    doc.text(`Participantes: ${this.participants.length}`, 14, 44);
                    doc.text(`Duración: ${this.participants.length} semanas`, 14, 51);
                    
                    // Estado actual
                    const completedWeeks = this.participants.filter((p, index) => {
                        return index < this.state.currentWeek && this.getWeeklyPaymentCount(index) === this.participants.length;
                    }).length;
                    
                    const totalCollected = completedWeeks * this.config.weeklyAmount * this.participants.length;
                    const totalPending = this.config.totalAmount - totalCollected;
                    
                    doc.text(`Semana Actual: ${this.state.currentWeek + 1}`, 14, 61);
                    doc.text(`Recaudado: ${totalCollected.toLocaleString()} Bs`, 14, 68);
                    doc.text(`Por Recaudar: ${totalPending.toLocaleString()} Bs`, 14, 75);
                    
                    // Tabla de participantes
                    doc.setFontSize(14);
                    doc.text('Cronograma de Participantes', 105, 85, { align: 'center' });
                    
                    const participantsData = this.participants.map((participant, index) => {
                        const weeklyPaid = this.getWeeklyPaymentCount(index);
                        const totalExpected = this.participants.length;
                        const status = weeklyPaid === totalExpected ? 'Completo' : 
                                        index === this.state.currentWeek ? 'Actual' : 'Pendiente';
                        
                        return [
                            participant.name,
                            participant.date,
                            status,
                            `${weeklyPaid}/${totalExpected}`
                        ];
                    });
                    
                    doc.autoTable({
                        startY: 90,
                        head: [['Nombre', 'Fecha', 'Estado', 'Pagos']],
                        body: participantsData,
                        theme: 'grid',
                        headStyles: {
                            fillColor: [26, 35, 50],
                            textColor: 255
                        },
                        alternateRowStyles: {
                            fillColor: [240, 240, 240]
                        },
                        margin: { top: 90 }
                    });
                    
                    // Progreso general
                    const progress = Math.round((completedWeeks / this.participants.length) * 100);
                    const finalY = doc.lastAutoTable.finalY + 10;
                    
                    doc.setFontSize(14);
                    doc.text('Progreso General', 105, finalY, { align: 'center' });
                    
                    doc.setFontSize(12);
                    doc.text(`${progress}% completado (${completedWeeks} de ${this.participants.length} semanas)`, 105, finalY + 10, { align: 'center' });
                    
                    // Guardar el PDF
                    doc.save(`pasanaku_${new Date().toISOString().split('T')[0]}.pdf`);
                    
                    this.showNotification('Reporte PDF generado correctamente', 'success');
                } catch (error) {
                    console.error('Error al exportar:', error);
                    this.showNotification('Error al generar el reporte PDF', 'error');
                }
            }

            async loadData() {
                try {
                    const savedData = JSON.parse(localStorage.getItem('pasanakuData') || '{}');
                    
                    if (Object.keys(savedData).length > 0) {
                        this.state.weeklyPayments = savedData.weeklyPayments || {};
                        this.state.currentWeek = savedData.currentWeek || 0;
                        
                        if (savedData.config) {
                            this.config = { ...this.config, ...savedData.config };
                        }
                        
                        this.participants.forEach((participant, index) => {
                            if (this.state.weeklyPayments[index]) {
                                participant.paid = this.getWeeklyPaymentCount(index) === this.participants.length;
                            }
                        });
                        
                        this.showNotification('Datos cargados correctamente', 'success');
                    }
                } catch (error) {
                    console.error('Error al cargar datos:', error);
                    this.showNotification('Error al cargar datos guardados', 'warning');
                }
            }

            saveData() {
                try {
                    const data = {
                        weeklyPayments: this.state.weeklyPayments,
                        currentWeek: this.state.currentWeek,
                        config: this.config,
                        lastSaved: new Date().toISOString()
                    };
                    
                    localStorage.setItem('pasanakuData', JSON.stringify(data));
                } catch (error) {
                    console.error('Error al guardar datos:', error);
                    this.showNotification('Error al guardar datos', 'error');
                }
            }

            showNotification(message, type = 'info', duration = 5000) {
                const container = document.getElementById('notificationContainer');
                if (!container) return;

                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.setAttribute('role', 'alert');
                notification.setAttribute('aria-live', 'polite');
                
                const icon = this.getNotificationIcon(type);
                notification.innerHTML = `
                    <i class="${icon} me-2" aria-hidden="true"></i>
                    ${this.escapeHtml(message)}
                `;
                
                // Agregar evento de click para cerrar
                notification.addEventListener('click', () => {
                    this.removeNotification(notification);
                });
                
                container.appendChild(notification);
                
                // Auto-remove después del tiempo especificado
                setTimeout(() => {
                    this.removeNotification(notification);
                }, duration);
            }

            getNotificationIcon(type) {
                const icons = {
                    success: 'fas fa-check-circle',
                    error: 'fas fa-exclamation-circle',
                    warning: 'fas fa-exclamation-triangle',
                    info: 'fas fa-info-circle'
                };
                return icons[type] || icons.info;
            }

            removeNotification(notification) {
                if (notification.parentNode) {
                    notification.style.opacity = '0';
                    notification.style.transform = 'translateX(100%)';
                    
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                    }, 300);
                }
            }

            showCollectionNotification() {
                if (this.state.currentWeek >= this.participants.length) {
                    this.showNotification('El pasanaku ha finalizado', 'info');
                    return;
                }

                const currentParticipant = this.participants[this.state.currentWeek];
                const weeklyPaid = this.getWeeklyPaymentCount(this.state.currentWeek);
                const totalExpected = this.participants.length;
                
                if (weeklyPaid === totalExpected) {
                    this.showNotification(`Todos los pagos para ${currentParticipant.name} ya han sido completados`, 'success');
                } else {
                    const message = `Recordatorio: ${currentParticipant.name} debe recoger ${this.config.totalAmount.toLocaleString()} Bs esta semana (${weeklyPaid}/${totalExpected} pagos completados)`;
                    this.showNotification(message, 'warning', 7000);
                    
                    setTimeout(() => {
                        this.showNotification('Notificación enviada a todos los participantes', 'info');
                    }, 1500);
                }
            }

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            // Método para limpiar recursos al destruir la instancia
            destroy() {
                if (this.state.updateInterval) {
                    clearInterval(this.state.updateInterval);
                }
                
                if (this.updateTimeout) {
                    clearTimeout(this.updateTimeout);
                }
                
                if (this.state.chart) {
                    this.state.chart.destroy();
                }
            }
        }

        // Inicializar el sistema cuando el DOM esté listo
        let pasanakuSystem;

        document.addEventListener('DOMContentLoaded', () => {
            pasanakuSystem = new PasanakuSystem();
        });

        // Funciones globales para acceso desde HTML
        window.showOwnerControls = () => pasanakuSystem?.showOwnerControls();
        window.validateOwnerPassword = () => pasanakuSystem?.validateOwnerPassword();
        window.resetPasanaku = () => pasanakuSystem?.resetPasanaku();
        window.exportData = () => pasanakuSystem?.exportData();
        window.showCollectionNotification = () => pasanakuSystem?.showCollectionNotification();
        window.togglePayment = (week, participantId) => pasanakuSystem?.togglePayment(week, participantId);

        // Limpiar recursos cuando se cierre la página
        window.addEventListener('beforeunload', () => {
            pasanakuSystem?.destroy();
        });

        // Manejar errores globales
        window.addEventListener('error', (event) => {
            console.error('Error global:', event.error);
            if (pasanakuSystem) {
                pasanakuSystem.showNotification('Ha ocurrido un error inesperado', 'error');
            }
        });
    </script>
</body>
</html>